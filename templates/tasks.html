{% extends "base.html" %}

{% block title %}Tasks - Task Manager{% endblock %}

{% block content %}
<div class="tasks-page">
    <div class="tasks-header">
        <h1>My Tasks</h1>
        <button onclick="openCreateModal()" class="btn btn-primary">+ New Task</button>
    </div>

    <!-- Filters -->
    <div class="filters">
        <div class="filter-group">
            <label>Status:</label>
            <select id="statusFilter" onchange="applyFilter('status', this.value)">
                <option value="">All</option>
                <option value="pending" {% if current_status == 'pending' %}selected{% endif %}>Pending</option>
                <option value="in_progress" {% if current_status == 'in_progress' %}selected{% endif %}>In Progress</option>
                <option value="completed" {% if current_status == 'completed' %}selected{% endif %}>Completed</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Priority:</label>
            <select id="priorityFilter" onchange="applyFilter('priority', this.value)">
                <option value="">All</option>
                <option value="low" {% if current_priority == 'low' %}selected{% endif %}>Low</option>
                <option value="medium" {% if current_priority == 'medium' %}selected{% endif %}>Medium</option>
                <option value="high" {% if current_priority == 'high' %}selected{% endif %}>High</option>
            </select>
        </div>

        <div class="filter-group">
            <label>Category:</label>
            <select id="categoryFilter" onchange="applyFilter('category', this.value)">
                <option value="">All</option>
                {% for category in categories %}
                    <option value="{{ category }}" {% if current_category == category %}selected{% endif %}>{{ category }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Tasks List -->
    <div class="tasks-grid">
        {% if tasks %}
            {% for task in tasks %}
                <div class="task-card" data-task-id="{{ task.id }}">
                    <div class="task-card-header">
                        <h3>{{ task.title }}</h3>
                        <div class="task-actions">
                            <button onclick="editTask({{ task.id }})" class="btn-icon" title="Edit">‚úèÔ∏è</button>
                            <button onclick="deleteTask({{ task.id }})" class="btn-icon" title="Delete">üóëÔ∏è</button>
                        </div>
                    </div>

                    {% if task.description %}
                        <p class="task-card-description">{{ task.description }}</p>
                    {% endif %}

                    <div class="task-card-meta">
                        <span class="badge badge-{{ task.status }}">{{ task.status.replace('_', ' ') }}</span>
                        <span class="badge badge-{{ task.priority }}">{{ task.priority }}</span>
                        {% if task.category %}
                            <span class="task-category">üìÅ {{ task.category }}</span>
                        {% endif %}
                    </div>

                    {% if task.due_date %}
                        <div class="task-card-date">
                            üìÖ Due: {{ task.due_date.strftime('%b %d, %Y') }}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state-large">
                <div class="empty-icon">üìù</div>
                <h3>No tasks found</h3>
                <p>Create your first task to get started!</p>
                <button onclick="openCreateModal()" class="btn btn-primary">Create Task</button>
            </div>
        {% endif %}
    </div>
</div>

<!-- Create/Edit Task Modal -->
<div id="taskModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Create New Task</h2>
            <button onclick="closeModal()" class="modal-close">&times;</button>
        </div>

        <form id="taskForm" class="task-form">
            <input type="hidden" id="taskId">

            <div class="form-group">
                <label for="title">Title *</label>
                <input type="text" id="title" name="title" required placeholder="Enter task title">
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" rows="4" placeholder="Enter task description"></textarea>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="category">Category</label>
                    <input type="text" id="category" name="category" placeholder="e.g., Work, Personal">
                </div>

                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select id="priority" name="priority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status" name="status">
                        <option value="pending" selected>Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="due_date">Due Date</label>
                    <input type="date" id="due_date" name="due_date">
                </div>
            </div>

            <div class="modal-actions">
                <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Task</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Task management JavaScript
let editingTaskId = null;

function openCreateModal() {
    editingTaskId = null;
    document.getElementById('modalTitle').textContent = 'Create New Task';
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('taskModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('taskModal').style.display = 'none';
    editingTaskId = null;
}

function applyFilter(type, value) {
    const url = new URL(window.location.href);
    if (value) {
        url.searchParams.set(type, value);
    } else {
        url.searchParams.delete(type);
    }
    window.location.href = url.toString();
}

async function editTask(taskId) {
    // In a real app, fetch task data from API
    // For now, redirect to edit functionality
    alert('Edit functionality - will be implemented with AJAX');
}

async function deleteTask(taskId) {
    if (!confirm('Are you sure you want to delete this task?')) {
        return;
    }

    try {
        const response = await fetch(`/api/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        if (response.ok) {
            // Remove task card from DOM
            document.querySelector(`[data-task-id="${taskId}"]`).remove();
            showMessage('Task deleted successfully', 'success');
        } else {
            showMessage('Failed to delete task', 'error');
        }
    } catch (error) {
        showMessage('An error occurred', 'error');
    }
}

// Handle form submission
document.getElementById('taskForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        category: document.getElementById('category').value,
        priority: document.getElementById('priority').value,
        status: document.getElementById('status').value,
        due_date: document.getElementById('due_date').value || null
    };

    const taskId = document.getElementById('taskId').value;
    const url = taskId ? `/api/tasks/${taskId}` : '/api/tasks';
    const method = taskId ? 'PUT' : 'POST';

    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            showMessage(taskId ? 'Task updated!' : 'Task created!', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showMessage('Operation failed', 'error');
        }
    } catch (error) {
        showMessage('An error occurred', 'error');
    }
});

function showMessage(message, type) {
    const flashContainer = document.querySelector('.flash-container') || createFlashContainer();
    const flash = document.createElement('div');
    flash.className = `flash flash-${type}`;
    flash.innerHTML = `${message} <button onclick="this.parentElement.remove()" class="flash-close">&times;</button>`;
    flashContainer.appendChild(flash);

    setTimeout(() => flash.remove(), 3000);
}

function createFlashContainer() {
    const container = document.createElement('div');
    container.className = 'flash-container';
    document.body.insertBefore(container, document.body.firstChild);
    return container;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('taskModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>
{% endblock %}
